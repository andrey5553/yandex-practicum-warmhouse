@startuml
!include <C4/C4_Component>

title Telemetry Service - .NET 8.0 Architecture

Container(telemetry_service, "Telemetry Service", ".NET 8.0/ASP.NET Core", "Сбор и хранение телеметрии устройств")

' === ОСНОВНЫЕ КОМПОНЕНТЫ ===
Component(api, "Telemetry Controller", "ASP.NET Core Controller", "REST API для телеметрии\n• POST /telemetry\n• GET /telemetry/devices/{id}\n• GET /telemetry/houses/{id}/aggregated")
Component(telemetry_service_layer, "Telemetry Service", "C# Service Layer", "Бизнес-логика обработки данных")
Component(mqtt_service, "MQTT Service", "MQTTnet", "Фоновая служба для MQTT")
Component(background_processor, "Background Processor", "BackgroundService", "Фоновая обработка агрегаций")

' === ХРАНИЛИЩА ===
ContainerDb(telemetry_db, "Telemetry DB", "PostgreSQL", "Сырые данные телеметрии\n(Entity Framework Core)")
Container(aggregation_cache, "Aggregation Cache", "Redis", "Агрегированные данные\n(StackExchange.Redis)")

' === ВНЕШНИЕ СИСТЕМЫ ===
System_Ext(devices, "IoT Devices", "MQTT", "Устройства и датчики")

' === API ПОТОКИ ДАННЫХ ===

' 1. POST /telemetry - отправка телеметрии (HTTP)
Rel(devices, api, "Данные телеметрии", "HTTP/JSON")
Rel(api, telemetry_service_layer, "Обработка запроса", "Dependency Injection")
Rel(telemetry_service_layer, telemetry_db, "Сохранение через EF Core", "SQL")

' 2. MQTT прием данных
Rel(devices, mqtt_service, "Поток телеметрии", "MQTT")
Rel(mqtt_service, telemetry_service_layer, "Обработка сообщений", "MediatR/Channel")
Rel(telemetry_service_layer, background_processor, "Задачи агрегации", "Channel/Queue")

' 3. GET /telemetry/devices/{id} - получение телеметрии устройства
Rel(api, telemetry_service_layer, "Запрос данных устройства", "DI")
Rel(telemetry_service_layer, telemetry_db, "LINQ запросы", "EF Core")
Rel(telemetry_db, telemetry_service_layer, "Данные устройства", "EF Core")
Rel(telemetry_service_layer, api, "DTO ответ", "JSON")

' 4. GET /telemetry/houses/{id}/aggregated - агрегированные данные
Rel(api, telemetry_service_layer, "Запрос агрегаций", "DI")
Rel(telemetry_service_layer, aggregation_cache, "Получение из кэша", "Redis")
Rel(aggregation_cache, telemetry_service_layer, "Кэшированные данные", "Redis")
Rel(background_processor, aggregation_cache, "Обновление агрегаций", "Redis")
Rel(telemetry_service_layer, api, "Агрегированные DTO", "JSON")

' Фоновая обработка
Rel(background_processor, telemetry_db, "Расчет агрегаций", "SQL")

note right of telemetry_service
  <b>.NET 8.0 Stack:</b>
  • ASP.NET Core Controllers
  • Entity Framework Core
  • MQTTnet библиотека
  • BackgroundService
  • StackExchange.Redis
  • Dependency Injection
end note

@enduml