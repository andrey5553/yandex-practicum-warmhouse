@startuml
!include <C4/C4_Component>

title Device Service - Упрощенная архитектура для API устройств

Container(device_service, "Device Service", "Python/FastAPI", "Управление IoT устройствами")

' === ОСНОВНЫЕ КОМПОНЕНТЫ ===
Component(api, "REST API", "FastAPI", "API для управления устройствами\n• GET /api/v1/devices\n• POST /api/v1/devices\n• POST /api/v1/devices/{id}/commands")
Component(device_manager, "Device Manager", "Business Logic", "Логика управления устройствами")
Component(protocol_handler, "Protocol Handler", "MQTT/HTTP", "Отправка команд устройствам")

' === ХРАНИЛИЩА ===
ContainerDb(device_db, "Device Database", "PostgreSQL", "Устройства, конфигурации, метаданные")
Container(state_cache, "State Cache", "Redis", "Текущее состояние устройств")

' === ВНЕШНИЕ СИСТЕМЫ ===
System_Ext(devices, "IoT Devices", "MQTT/HTTP", "Физические устройства")

' === API ВЗАИМОДЕЙСТВИЯ ===

' 1. Получение всех устройств
Rel(api, device_manager, "GET /devices", "HTTP")
Rel(device_manager, device_db, "Запрос устройств", "SQL")
Rel(device_db, device_manager, "Список устройств", "SQL")
Rel(device_manager, api, "Данные устройств", "HTTP")

' 2. Создание устройства
Rel(api, device_manager, "POST /devices", "HTTP")
Rel(device_manager, device_db, "Создание записи", "SQL")
Rel(device_db, device_manager, "ID устройства", "SQL")
Rel(device_manager, api, "Результат создания", "HTTP")

' 3. Отправка команды устройству
Rel(api, device_manager, "POST /devices/{id}/commands", "HTTP")
Rel(device_manager, device_db, "Проверка устройства", "SQL")
Rel(device_manager, protocol_handler, "Команда", "internal")
Rel(protocol_handler, devices, "Отправка команды", "MQTT/HTTP")
Rel(devices, protocol_handler, "Подтверждение", "MQTT/HTTP")
Rel(protocol_handler, state_cache, "Обновление состояния", "Redis")
Rel(protocol_handler, device_manager, "Результат выполнения", "internal")
Rel(device_manager, api, "Статус команды", "HTTP")

note right of device_service
  <b>Поддерживаемые API:</b>
  • GET /api/v1/devices
  • POST /api/v1/devices  
  • POST /api/v1/devices/{id}/commands
end note

note left of protocol_handler
  <b>Протоколы устройств:</b>
  • MQTT (основной)
  • HTTP REST
  • WebSocket
end note

@enduml