@startuml
!include <C4/C4_Component>

title Device Service - Архитектура компонентов

Container(device_service, "Device Service", "Python/FastAPI", "Управление IoT устройствами и датчиками")

' === ОСНОВНЫЕ КОМПОНЕНТЫ ===
Component(device_api, "Device API", "FastAPI", "REST API для управления устройствами")
Component(sensor_api, "Sensor API", "FastAPI", "REST API для управления датчиками")
Component(device_manager, "Device Manager", "Business Logic", "Управление жизненным циклом устройств")
Component(state_manager, "State Manager", "State Machine", "Real-time состояние устройств")
Component(protocol_adapter, "Protocol Adapter", "MQTT/HTTP/WS", "Адаптер IoT протоколов")

' === ПОДКОМПОНЕНТЫ ПРОТОКОЛОВ ===
Component(mqtt_handler, "MQTT Handler", "Paho-MQTT", "Общение по MQTT")
Component(http_handler, "HTTP Handler", "HTTP Server", "REST API для устройств")
Component(websocket_handler, "WebSocket Handler", "WS Server", "Real-time обновления")

' === ХРАНИЛИЩА ДАННЫХ ===
ContainerDb(device_db, "Device Database", "PostgreSQL", "Метаданные устройств и конфигурации")
Container(redis_cache, "Redis Cache", "Redis", "Real-time состояние устройств")
Container(message_broker, "Message Broker", "Apache Kafka", "События и телеметрия")
Container(file_storage, "File Storage", "MinIO/S3", "Конфигурации устройств")

' === ВНЕШНИЕ СИСТЕМЫ ===
System_Ext(iot_devices, "IoT Devices", "MQTT/HTTP/WS", "Физические устройства и датчики")

' === ОСНОВНЫЕ ВЗАИМОДЕЙСТВИЯ ===

' Внутренняя логика
Rel(device_api, device_manager, "Команды устройствам", "internal")
Rel(sensor_api, device_manager, "Управление датчиками", "internal")
Rel(device_manager, state_manager, "Обновление состояния", "internal")
Rel(device_manager, protocol_adapter, "Отправка команд", "internal")

' Протокольные обработчики
Rel(protocol_adapter, mqtt_handler, "MQTT команды", "internal")
Rel(protocol_adapter, http_handler, "HTTP команды", "internal")
Rel(protocol_adapter, websocket_handler, "WS команды", "internal")

' Взаимодействие с устройствами
Rel(mqtt_handler, iot_devices, "MQTT over TLS", "Pub/Sub")
Rel(http_handler, iot_devices, "REST API", "HTTPS")
Rel(websocket_handler, iot_devices, "Real-time", "WSS")

' Работа с данными
Rel(device_manager, device_db, "Метаданные устройств", "SQL")
Rel(state_manager, redis_cache, "Состояние в реальном времени", "Redis")
Rel(device_manager, message_broker, "События устройств", "Kafka")
Rel(device_manager, file_storage, "Конфигурации", "S3 API")

' Телеметрия от устройств
Rel(iot_devices, mqtt_handler, "Данные датчиков", "MQTT")
Rel(mqtt_handler, state_manager, "Обновление состояния", "internal")
Rel(mqtt_handler, message_broker, "Поток телеметрии", "Kafka")

note right of device_service
  <b>Основные функции:</b>
  • Управление устройствами
  • Real-time состояние
  • Мульти-протокольная поддержка
  • Конфигурация устройств
  • Сбор телеметрии
end note

note left of protocol_adapter
  <b>Поддерживаемые протоколы:</b>
  • MQTT 3.1.1/5.0
  • HTTP/REST API
  • WebSocket
end note

note bottom of device_db
  <b>Хранит:</b>
  • Устройства
  • Датчики  
  • Конфигурации
  • История команд
end note

@enduml